# Day 11: Cosmic Expansion

# Init --------------------------------------------------------------------
library(tidyverse)

# Data --------------------------------------------------------------------

test1 <- "...#......
.......#..
#.........
..........
......#...
.#........
.........#
..........
.......#..
#...#....."


data <- "........................#...............................................#................................#................................#.
....#..............#......................#............#....................................................................#...............
................................#.............................................................#.............................................
.........#.....................................#...................#........................................................................
....................................................#.......................#..............................#................................
..#................................................................................................#................#......................#
.........................................................#.........................#.....#..................................................
..................................#.............................#...............................................#.............#.............
.......#.....#...........................#..............................................................#.............................#.....
......................#...............................#................................................................#....................
............................#.................#........................#.....................................#..............................
....#.................................#...............................................#.....................................................
...............#...........................................................#............................................................#...
..................................#...........................................................#...................#...........#.............
....................................................................................................................................#.......
................................................................#................#..........................#...............................
...#..............#........#.........#.............#........................................................................................
.........................................................#.............#.............#..............#...................#...................
........#...................................................................................................................................
..............................................................................................#.................................#........#..
....................#.......................................#.....................................................#.........................
#..............................#.......#......#...................................#......#..................................................
...........#.......................................#......................................................................#.................
.......................................................................................................................................#....
............................................................................................................................................
.........................#...................................#...............................#..............................................
..................................#.......................................................................#.............#...................
.........................................#...........................#...............................#.........#..........................#.
............#......#............................................#...............................#...................................#.......
.............................#.....................................................#........................................................
....#........................................#...............................#.................................................#............
......................#............................#.....#.........#........................................................................
.........................................................................................................#..................................
.......#........................#................................................#..........................................................
...............................................#..........................#................#..........................................#.....
.#................#.............................................................................................#......#....................
..............................................................................................................................#.............
..........................#........................#.............................................#..........................................
.............#..........................#............................................#..............................#.......................
........#..............................................#.....................#..........................#..................#................
............................................................#.....#..................................................................#......
....................#.........................#..........................#..................#...................#...........................
..............................#...................................................#................#........................................
.........................................#..............................................#..................................................#
.#........#.........................................#.....................................................#.....................#...........
.........................................................#.........................................................#........................
......#...........................#.........................................................................................................
................................................#........................................................................................#..
...................................................................#...............#........................................................
.....................#................................#..............................................................................#......
...........#................................................................................#.....#.........................................
....#........................#............................................#..............................................#..................
................#.......#........................................................#........................................................#.
#...................................................................................................................#.......................
....................#...................#..............#.................................#...................#..............................
.............#....................#.................................................#..................#...................#................
.................................................................................................................#.....................#....
................................................................................#...........................................................
.......................#.............#....................#.................................................................................
.......#.............................................................................................#..............#.......................
...................#.....................................................................................................................#..
......................................................#..................#.......................................................#..........
..........................#..................................................................#..............................................
............#.................................#.........................................#...................#............#..................
.....................#......................................#......................................................#..........#.............
.#.........................................................................#......#...................#.....................................
............................................................................................................................................
................................#...........................................................#...............................................
........................................#..........................#..................................................#.................#...
....#........................................#.....................................................#.............................#..........
..........................................................#.................................................................................
...............#............................................................................................................................
..........#............#............................#.............................#...........................................#......#......
....................................#........................................................#...............#..............................
...........................................#..............................#...............................................................#.
.#...........................#.......................................................................#......................................
.........................................................#...........#....................................#.................................
......#.......#...................#...........................#.......................#.........#..................#........................
............................................................................#.........................................................#.....
.....................#.........................................................................................#........#...................
..........................#.............................................#................#........................................#.........
............................................................................................................................................
....#.....#.....#..................................#.........#.....................#....................#...................................
........................................#.....................................................................................#.............
...............................................................................................#............................................
.......#........................#...........................................#............................................................#..
....................#......#....................#...........................................................................................
.........................................................#...........#..........#.............................#...........#.................
......................................................................................#.....................................................
....................................................................................................#................#..........#.....#.....
............#.........#.....................#...............#..............................................#................................
.......#............................#.......................................................................................................
.......................................................................#......................#................#...................#........
............................................................................................................................................
........................................................................................................................#...................
..........#..........#.......................#.........................................................................................#....
...................................................................#.................#...........#..........................................
........................................#................#..................................................................................
................#....................................................................................................#......................
............................................................................................................................................
.......#....................#.................................................................#...............#.........................#...
.................................#...........#.....#...........................................................................#............
...........#.......................................................#....................#...................................................
........................................#...............................................................................#...................
............................................................................................................................................
.....................................................................................................#......................................
................#.........................................#..................#................................................#.......#.....
....#................................#.............#...................................#.....................#.......#......................
.........................#......................................#...........................................................................
...........................................................................................#.......#........................................
..........#.....................#..............#........................#...................................................................
..#.........................................................................................................................................
....................#.....................................#.......................#.........................................................
..........................#.............#...............................................................................#.........#.........
......................................................................................#.....................................................
.....................................................................#..........................#...........................................
.......#.........#...........................................................#.......................#........#............#............#...
........................#....................................#..............................................................................
.......................................#............................................#....................#.........................#........
..............................................#....................................................................#........................
..............#..................#.....................................#..........................#.........................................
..........................................#..........#..........................#...........................................................
.....#......................................................................................#................#..............................
.....................#................................................................#.......................................#.............
.....................................................................#......................................................................
...........#.....#............................#.....................................................................................#.......
................................#.....#..........................#........#..........................................#....................#.
...........................#.................................................................#........#.......#.............................
#...........................................................................................................................................
........#........................................#...................................#......................................................
.............................................................................................................................#..............
.................................#..............................#........................#.........#........#...............................
............#.....#..........................#.......................#....................................................................#.
........................#........................................................#..........................................................
............................................................#..............#......................................#.........................
...#........................................................................................#...............................................
...........................................................................................................#......................#.........
..........#.......................................................................................#.........................................
......................#................#............................................#.................................................#.....
...........................#.....................#........#...................................................#............................."

# Part One: Description ---------------------------------------------------
# You continue following signs for "Hot Springs" and eventually come across an 
# observatory. The Elf within turns out to be a researcher studying cosmic 
# expansion using the giant telescope here.
# 
# He doesn't know anything about the missing machine parts; he's only visiting 
# for this research project. However, he confirms that the hot springs are the 
# next-closest area likely to have people; he'll even take you straight there 
# once he's done with today's observation analysis.
# 
# Maybe you can help him with the analysis to speed things up?
# 
# The researcher has collected a bunch of data and compiled the data into a 
# single giant image (your puzzle input). The image includes empty space (.) and 
# galaxies (#). For example:
# 
# ...#......
# .......#..
# #.........
# ..........
# ......#...
# .#........
# .........#
# ..........
# .......#..
# #...#.....
#
# The researcher is trying to figure out the sum of the lengths of the shortest 
# path between every pair of galaxies. However, there's a catch: the universe 
# expanded in the time it took the light from those galaxies to reach the 
# observatory.
# 
# Due to something involving gravitational effects, only some space expands. In 
# fact, the result is that any rows or columns that contain no galaxies should 
# all actually be twice as big.
# 
# In the above example, three columns and two rows contain no galaxies:
#   
#   v  v  v
# ...#......
# .......#..
# #.........
# >..........<
#   ......#...
# .#........
# .........#
# >..........<
#   .......#..
# #...#.....
# ^  ^  ^
#
# These rows and columns need to be twice as big; the result of cosmic 
# expansion therefore looks like this:
#   
#   ....#........
# .........#...
# #............
# .............
# .............
# ........#....
# .#...........
# ............#
# .............
# .............
# .........#...
# #....#.......
#
# Equipped with this expanded universe, the shortest path between every pair of 
# galaxies can be found. It can help to assign every galaxy a unique number:
#   
#   ....1........
# .........2...
# 3............
# .............
# .............
# ........4....
# .5...........
# ............6
# .............
# .............
# .........7...
# 8....9.......
#
# In these 9 galaxies, there are 36 pairs. Only count each pair once; order 
# within the pair doesn't matter. For each pair, find any shortest path between 
# the two galaxies using only steps that move up, down, left, or right exactly 
# one . or # at a time. (The shortest path between two galaxies is allowed to 
# pass through another galaxy.)
# 
# For example, here is one of the shortest paths between galaxies 5 and 9:
# 
# ....1........
# .........2...
# 3............
# .............
# .............
# ........4....
# .5...........
# .##.........6
# ..##.........
# ...##........
# ....##...7...
# 8....9.......
#
# This path has length 9 because it takes a minimum of nine steps to get from 
# galaxy 5 to galaxy 9 (the eight locations marked # plus the step onto galaxy 9 
# itself). Here are some other example shortest path lengths:
# 
# Between galaxy 1 and galaxy 7: 15
# Between galaxy 3 and galaxy 6: 17
# Between galaxy 8 and galaxy 9: 5
# In this example, after expanding the universe, the sum of the shortest path 
# between all 36 pairs of galaxies is 374.
# 
# Expand the universe, then find the length of the shortest path between every 
# pair of galaxies. What is the sum of these lengths?



# Part One ----------------------------------------------------------------
#
# Manhattan geometry!
#
# OXOOOO    OX***O    
# O**OOO    OOOO*O    
# OO**OO    OOOO*O    
# OOO**O    OOOO*O    
# OOOOXO    OOOOXO    
#
# 6 steps   6 steps 
# between   between
#
# The easies way to tackle this exercise is to expand the matrix. It isn't the
# most efficient way though. 
#

enumerate_galaxies <- function(universe, galaxy = "#") {
  new_universe <- matrix(0, nrow = nrow(universe), ncol = ncol(universe))
  n <- 1
  for(y in 1:nrow(universe)) {
    for(x in 1:ncol(universe)) {
      if(universe[y, x] == galaxy) {
        new_universe[y, x] <- n
        n <- n + 1
      }
    }
  }
  return(new_universe)
}

manhattan_distance_expanding <- function(universe, starty, startx, endy, endx, expansion = 2) {
  dx <- sum(apply(universe[min(starty, endy):max(starty, endy),, drop = FALSE], 1,  \(x) {all(x == 0)})) + sum(apply(universe[, min(startx, endx):max(startx, endx), drop = FALSE], 2,  \(x) {all(x == 0)}))
  return( abs(endy - starty) + abs(endx - startx) - dx + dx * expansion )
}

universe <- data |> 
  str_split_1("\n") |> 
  str_split("") |> 
  {\(x) unlist(x) |> matrix(ncol = length(x), byrow = TRUE)}() |> 
  enumerate_galaxies()

combinations <- combn(1:max(universe), 2)
s <- 0
for(i in 1:ncol(combinations)) {
  g1 <- which(universe == combinations[1, i], TRUE)  
  g2 <- which(universe == combinations[2, i], TRUE) 
  d <- manhattan_distance_expanding(universe, g1[1], g1[2], g2[1], g2[2])
  print(paste0("Galaxy ", combinations[1, i], " -> ", combinations[2, i], ", d = ", d ))
  s <- s + d
}
s

# Answer: 9556712



# Ok, lets try to simplify that.

universe <- data |> 
  str_split_1("\n") |> 
  str_split("") |> 
  {\(x) unlist(x) |> matrix(ncol = length(x), byrow = TRUE)}()

empty_rows <- which(rowSums(universe == "#") == 0)
empty_cols <- which(colSums(universe == "#") == 0)
galaxies <- which(universe == "#", arr.ind = TRUE)

manhattan_distance_expanding_v2 <- function(pos, combinations, galaxies, empty_cols, empty_rows, expansion = 2) {
  g1 <- galaxies[combinations[1, pos],]
  g2 <- galaxies[combinations[2, pos],]
  ef <- between(empty_rows, min(g1[[1]], g2[[1]]),  max(g1[[1]], g2[[1]])) |> sum() + between(empty_cols, min(g1[2], g2[2]), max(g1[2], g2[2])) |> sum()
  return( abs(g1[[1]] - g2[[1]]) + abs(g1[[2]] - g2[[2]]) - ef + ef * expansion )
}

combinations <- combn(1:length(galaxies[,1]), 2)
lapply(1:ncol(combinations), manhattan_distance_expanding_v2, combinations = combinations, galaxies = galaxies, empty_cols = empty_cols, empty_rows = empty_rows, expansion = 2) |> 
  unlist() |> 
  sum()

# Answer: 9556712

# Part Two: Description ---------------------------------------------------
# The galaxies are much older (and thus much farther apart) than the researcher 
# initially estimated.
# 
# Now, instead of the expansion you did before, make each empty row or column 
# one million times larger. That is, each empty row should be replaced with 
# 1000000 empty rows, and each empty column should be replaced with 1000000 
# empty columns.
# 
# (In the example above, if each empty row or column were merely 10 times 
# larger, the sum of the shortest paths between every pair of galaxies would be 
# 1030. If each empty row or column were merely 100 times larger, the sum of the 
# shortest paths between every pair of galaxies would be 8410. However, your 
# universe will need to expand far beyond these values.)
# 
# Starting with the same initial image, expand the universe according to these 
# new rules, then find the length of the shortest path between every pair of 
# galaxies. What is the sum of these lengths?
#   
#   
# Part Two ----------------------------------------------------------------
#
# The tricky part was to figure out how to maintain the shape of a matrix when
# extracting just one column or row. R kept coercing it down to a one-
# dimensional vector. When I found out about drop = FALSE everyting worked.
#
# Since the distances are much larger actually expanding the universe matrix 
# won't work. But since we're dealing with Manhattan geometry we can just 
# count the number of times a path crosses rows and columns with only empty 
# space and count these multiple times.
#
# Just change the expansion factor from 1M to 2 for Part One...
#
universe2 <- data |> 
  str_split_1("\n") |> 
  str_split("") |> 
  {\(x) unlist(x) |> matrix(ncol = length(x), byrow = TRUE)}() |> 
  enumerate_galaxies()
combinations2 <- combn(1:max(universe2), 2)

s <- 0
for(i in 1:ncol(combinations2)) {
  g1 <- which(universe2 == combinations2[1, i], TRUE)  
  g2 <- which(universe2 == combinations2[2, i], TRUE) 
  d <- manhattan_distance_expanding(universe2, g1[1], g1[2], g2[1], g2[2], 1000000)
  print(paste0("Galaxy ", combinations2[1, i], " -> ", combinations2[2, i], ", d = ", d ))
  s <- s + d
}
s
# Answer: 678626199476



# And lets try that again...
universe2 <- data |> 
  str_split_1("\n") |> 
  str_split("") |> 
  {\(x) unlist(x) |> matrix(ncol = length(x), byrow = TRUE)}()

empty_rows <- which(rowSums(universe2 == "#") == 0)
empty_cols <- which(colSums(universe2 == "#") == 0)
galaxies2 <- which(universe2 == "#", arr.ind = TRUE)
combinations2 <- combn(1:length(galaxies2[,1]), 2)

lapply(1:ncol(combinations2), manhattan_distance_expanding_v2, combinations = combinations, galaxies = galaxies, empty_cols = empty_cols, empty_rows = empty_rows, expansion = 1000000) |> 
  unlist() |> 
  sum()

# Answer: 678626199476





# Old stuff
# expand_universe <- function(universe) {
#   c <- c()
#   r <- c()
#   for(x in 1:ncol(universe)) {
#     if(all(universe[, x] == ".")) c <- append(c, x)
#   }
#   for(y in 1:nrow(universe)) {
#     if(all(universe[y,] == ".")) r <- append(r, y)
#   }
#   if(length(c) > 0) {
#     for(x in 1:length(c)) {
#       universe <- cbind(universe[,1:(c[x] + x -1)], 
#                         matrix(".", ncol = 1, nrow = nrow(universe)), 
#                         universe[, (c[x] + x):ncol(universe)])
#     }
#   }
#   if(length(r) > 0) {
#     for(y in 1:length(r)) {
#       universe <- rbind(universe[1:(r[y] + y - 1),], 
#                         matrix(".", ncol = ncol(universe), nrow = 1), 
#                         universe[(r[y] + y):nrow(universe),])
#     }
#   }
#   return(universe)
# }

# manhattan_distance <- function(starty, startx, endy, endx) {
#   return(abs(endy - starty) + abs(endx - startx))
# }
#
# universe <- expand_universe(universe)