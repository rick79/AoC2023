# Day 12:Hot Springs

# Init --------------------------------------------------------------------
library(tidyverse)
library(cachem)
library(rlang)

# Data --------------------------------------------------------------------
test1 <- "#.#.### 1,1,3
.#...#....###. 1,1,3
.#.###.#.###### 1,3,1,6
####.#...#... 4,1,1
#....######..#####. 1,6,5
.###.##....# 3,2,1"

test2 <- "???.### 1,1,3
.??..??...?##. 1,1,3
?#?#?#?#?#?#?#? 1,3,1,6
????.#...#... 4,1,1
????.######..#####. 1,6,5
?###???????? 3,2,1"

data <- "..???.??.? 1,1,1
?#?##???.???? 2,5,1,1
?#??????##? 1,1,2
?#.#?#??#??? 1,7,1
?#???#?#??.#.###.? 3,1,3,1,3,1
?#......#.?.?. 1,1,1
.????#????? 2,1,2
#.?...?#????#??? 1,7,1
?.#??.??#? 2,1,1
.#???###?#??#???#?.? 7,1,7
?###?.??#??..? 5,4
.#?.??#????#?.?. 2,4,1,1
#.#??????? 1,1,4
#????##.???#???. 1,1,2,1,5
?.?.##???#???##.? 2,7
????.?#?.? 2,2
??.#?????#??#. 1,10
???????.???#?? 6,1,2
#?.#???.?? 2,4,1
?####????.?.?? 4,3,2
?????#???? 6,1
????.???????#?#.? 1,5
.#???##.?#??#??? 6,5
??#?#?????????????. 8,4,1
???.????#?#.???? 7,4
?#???#?.?????????? 2,1,8,1
#?.#?#?.?? 1,3,2
?.??##??????.?. 1,5,1
????#????????#????.? 5,9
?.#?#????? 1,5
??????#.??.??.? 1,5,1,2
##?#??????#.#?#??? 5,1,2,6
????.?##?#..# 2,3,1,1
??.?..???.?#?#? 2,4
???##???.?#??#?# 1,5,6
??.????#?????#?? 1,9
??##?#????.#???.#??? 1,8,4,1,1
##?#???????. 4,1,3
?#???##?????#? 1,1,6,1
????????##?#?????? 1,14
????#????.??? 1,2,1,1
?##.???.#???.#?.??# 3,1,1,4,2,1
?##???????? 2,2,1
?????#??????.??# 1,5,1,1
#?#?????????#.? 5,1,1,2,1
.?.?.??.#. 1,1,1
.?#.??#?#?????###?. 2,12
??.?????#???.???? 1,1,1,4,2
??????#?##?#?? 2,6
..????#?##???? 1,4,1
.?#?#??.#???. 2,1,1,1
.??????#?? 1,1,1
?#?.?#???#???#? 1,4,1,2
??????????#???##?. 1,1,10
???##????.??? 1,4,1,2
.???#??.##???????##? 5,3,1,6
?#??#???.??? 1,1,1
.??..?????#. 1,4,1
???#?????.. 1,3,1
?#???.?#???#?..#??# 2,1,5,1,2
?#??#?.???.#???. 1,3,1,2
.#??#?.???#???#?? 1,1,9
?.?#?##...??? 1,4,1,1
??#?#?#??##???????. 3,3,3,1,3
???#?#?.??#? 6,3
?#?.#??##.#? 1,1,2,2
?????##??#??? 6,3,1
????##???? 1,2
???.???.???.?. 2,2,3
??#????????????# 5,1,1,3
????#?.?..????.??# 2,1,1,2,1,1
.?##?##???? 3,4
?..??????#? 1,1,5
..?????#.?.##?#.?? 4,4
#???.?????? 2,2
?.??#??????.? 1,4,2
?###??#???.?#?.?? 3,1,1,2,1
?????????.????????# 1,1,1,2,4
??#.??#?##.???.???? 1,1,6,3,1,1
???#.###????. 3,4,1
?#.?????????.?# 1,3,3,1
#.???#.????????#?? 1,1,1,2,7
???#?.?????.#? 1,1,4,1
???#..???.? 3,3
?.????#####??#.?#?? 1,1,9,1,1
????#.?#???? 2,1,5
.#?#..#??????????? 3,1,9
?.??..???? 2,1
???????#??.???????.? 1,1,4,1,1,2
..??.??????? 1,1
??.?????##?? 1,6
????????##??.????? 1,7,1,1,1
???.?###???? 1,5
#.?###??#?#???????? 1,4,1,1,3,1
????.???????????? 2,1,7
#?#??#????.?#????? 7,1,1,1
?##???#.?#???#?##??# 3,1,2,4,1
???#??#?????.?##? 7,3
?????????..??? 1,5,1
.???#???.????#.? 5,1,1,1
?#?????#????? 2,3,1
.???#???#???..??##. 5,1,4
?????.?##.# 5,2,1
??#????#?.# 5,2,1
#?.????#???#????? 2,1,2,1,2
????????.??.?????? 7,5
..#?#??###.??????? 8,3
#?.??.??##?.?#? 1,1,5,3
.#????#?#?##?. 1,8
?#?????#.? 1,3
.???.?..#? 1,1,1
??.??.????? 2,1
?#??????#??##?##... 1,11
.#?????????? 1,1,3,1
??#????#?????#??#?? 8,5
?#??#???..##.?? 7,2,2
?.????.#??#?.?##?? 1,1,1,2,5
.?.????????#??##??? 1,2,5,4
?.???##?.????#???## 5,3,4
#..#?##?#?#?????? 1,8,4
?????##?.?#.?? 1,4,2,1
?????????. 4,1
???#??.???????#?. 5,5,1
?.???.?#????##???# 1,1,8,1,1
???????..????? 1,3,4
?#?##??#?????#?#???? 8,6
???#????#.??????..?. 5,3,6,1
?.??##???.??#? 6,2
??.??.???#????#??? 2,1,8
?????##????.#?. 1,1,7,1
??.??#??.?.##? 5,3
???.?#?#??..?? 1,5,1
.#????##?????? 1,7,1
.??????..#?. 1,1,1
#?#??##.?.??. 7,1
?##?#???..?#.???# 4,1,2,1,1
???????#?? 3,3
?.????.#?#??##.??.? 1,1,4,2,1,1
?.?????##?.? 1,1,5,1
.#???.?.?##.?.? 1,1,2,1,1
#.??.?#?#? 1,1,3
?????.?#??#???# 1,1,8
.??#?##??.??.# 1,6,1,1
#??????#??#???#? 1,6,1,2
.??..?#????#???#??? 2,3,7
.??#.??##.?#?.#?#? 1,1,4,1,3
???.??#???.???. 2,1,1,2
?#?..???#??.? 1,2,3
?#??#.#????????.?.?? 1,1,6,1,1,2
#??##?#????.?#???## 1,4,1,1,1,2
.???#?????? 1,2,1
??.?.?##..??#?. 1,2,3
?.#?.#?#??#??#?? 2,3,6
?#??.#??.???????? 1,1,2,6
?#??.#???#???#.??.?? 4,1,6,1,1
##????#?.??????# 4,1,2,1
..?##????.. 3,3
.??#?.???? 3,1
??..????#?.?? 1,2,2,2
?.????.???.#..#? 2,1,1,1,2
??#?##?#??##. 6,3
????????.?????.?.# 1,1,3,1,1,1
.?#?###?#?????.???? 8,2,3
.???##??#?.?? 5,3,1
.?#??##??#.?# 9,1
?##???.??????? 3,1,1,2
?#?#?#?????????????? 6,1,1,1,1,1
.??#??##???#????. 11,1
?#.#????##?? 2,1,1,4
?.?.?.??#?????.??# 1,1,8,1,1
?.??.?????.? 1,1,4,1
?.#???.##.????.??? 1,2,1,2,3,2
.?.#??#??? 1,1,1
?.???????## 6,2
?.?.#?.##???.?. 1,2,2,1,1
???..?.??#???#????# 2,1,1,1,3,2
?????????.??#? 2,1,2
.?.?#.#??#?????#??? 1,1,4,1,1,1
????#??.?#????#??? 4,4,2
.????.?..?.??.?#.?. 1,2
??#?????#?#??.??#??? 1,1,8,4,1
?????????? 1,4
?.?#??.?#?????#? 2,3,4
???.##.??.??? 1,2,1,1
.?.???????#.#.. 8,1
#??.????###??????? 1,1,3,8
??#?#.#??..?? 3,2
#..??.????#???.#?#?. 1,1,5,1,1,1
??.??.???#??.? 2,1,6,1
.????##???? 1,7
.?###?.??.? 4,1,1
?.?#??#?.#..??#??? 6,1,1,1,1
.??????.?# 4,1
##????.?????.?? 6,2,1,1
.?????#.?? 1,3,1
?.????#??#?????? 6,3,1
.????#?.#?.?????#?# 6,2,6,1
.?.???#????###???##? 4,10
?..?#????? 4,1
.??#??.?##.?.#?#?#? 3,3,1,1,1,2
..??#.??????.? 3,1
??????????#?????.. 1,6,1
??#????#?????###?? 7,6
???..#???? 1,1,1
..#?#??...???#?.? 1,1,1,4,1
..#..????#???####. 1,10
?#??????.??? 1,2,1,1
??????.#???. 5,4
??#?#.????? 4,1,2
?#??.??.??#.? 1,1,2,2
#???.??#??#?.?#??##? 1,1,1,5,7
???.??#?.?#?? 1,4,1
.??????#???#????#?. 3,5,6
???????#?? 2,2
#??#?#?###?..??#???? 1,4,4,1,3
?##??????#?##???? 4,2,7
???????..?.#???? 5,1,1,4
?????????#???#??? 1,1,1,7,2
?.##.???????#???. 2,6,1,1
.?##?#?.?#?..?. 5,3
.????.?.?. 2,1
??#??#?.????.??..? 5,2,2,1
????##?#???. 1,3,1,1
#?.??##?###.??#? 1,1,6,1,2
?.?.?#?.#?.? 1,3,1,1
?????????##???##???. 2,2,3,6
#????????.???##.? 4,4,5
???????..???? 5,1,3
??.????##????###??? 2,1,5,5,1
??...??#????#???. 2,8,1
???#??????? 1,3,2
????.??..?.?? 2,1
.???.#?????. 1,6
??#?????#.??.#?? 3,1,1,1,1
##?.???##????????? 2,4,1,2,1
???###??##?.?.?.???? 9,2
???#????.? 1,6
??#???#?..#.#?? 5,2,1,3
.??#????????#? 8,1
?.?#??#????#??? 1,5,1,2
???..?.????#???#.? 1,1,1,3,1,1
????##???.#?#?. 4,4
??#?.#???? 3,2
?.#??#???#????? 1,6,1,1,1
??????#?#??#?.???? 1,1,7,1,1
?.?????.?. 2,1,1
.??##?.?#???? 2,2
.#??#??#?????.??#.? 1,5,2,2
?.??#?.???# 3,1,2
?..???????? 1,5
#?????????#?#??.?#. 2,1,2,7,2
?.?????##.?#??# 1,2,2,2,1
?????.??##. 2,4
??##??#??.?#?????. 1,6,6
???###???? 5,1
###???#???.????????. 4,1,1,1,2,1
??.???#.?#?. 2,3,1
?#?.??#?.?#????#?? 1,2,1,3
?????????#?? 1,7
??????????????????.? 1,5,4,4,1
?#.?.???#?? 1,5
?###?????#??? 5,2,3
?.???#???#??????. 1,1,4,2,1
?????#??####.##??#? 6,4,2,3
???.#???.???#???? 4,4
??#?.#?###????? 1,6,2
??????#?#?#???.????? 2,8,3,1
.?????.???????????? 1,4,3
?????.?##???? 4,3
???#???.??#??? 4,1,4
#?????.?.#. 3,1,1
.?##???##?#??????. 2,1,4,1,1,1
??????#?.????. 6,3
?.???#?#?#??.#??# 2,1,5,1,1
???##?##?.?.??#.? 8,3
???#???????..?? 1,1,1,2,1
??#???#.??#??..??? 7,1,3,1
????#?.?.#.?? 5,1,1,1
#??##.?#????#???? 1,2,1,5,1
???#.????..?##?? 4,1,2,1
???#?????.??.????# 5,1,1,1,2
????.?.??#?????#? 1,1,1,1,8
???#???#??## 2,5,2
#.????#?.?#????????? 1,5,1,1,1,1
##?#?#?.?? 6,1
.#?#??????#????.?? 1,2,3,2,1
?#?????.#?? 7,2
???#????.?. 1,4
?.#.?.???.##.## 1,1,2,2,2
???????.?.??#??#.? 2,4
????.???.#?? 2,2,1,1
.??#?#?????#?#??#? 5,3,4,2
##?????????.?????? 6,2,2,2
???#???????? 1,1,2,1
???????????..??#? 2,1,1,1,3
?????.??.???? 5,1,3
?????????..?# 1,2,2,1
??????????.?#..?? 3,4,2
???#?#?????#..????? 9,3
??????.?#??#???#? 1,4,1,6
??#?#????.??? 5,1
???#.?#?????##. 3,9
?????#???.????#? 2,1,4,1,3
.??#???..???? 6,3
?#.?#..??. 1,2,2
.????????.? 1,2,1
??.?#??.???? 1,2,1,1
.?..#?.??.?.??? 1,1,2,1,1
???#?#????###???? 2,1,3,4,2
????..??## 1,2,4
????????..???#????#? 1,3,1,9
??#????.##?..??? 5,2,2
???????##.???#?. 3,5,3
?#???.???????? 4,8
???????#???..#?.? 4,5,2,1
???.??##????.#??.? 1,8,1,1,1
??.?###???.??#.?? 1,6,1,1,1
???.##??#?#? 3,7
.??.???????????? 1,6,5
?#?#?.??.??.??? 5,1,1,1
?????#????#???#??#. 5,2,5
??#?#?.??#??#??????# 4,13
#??#????.???## 8,1,2
????.????. 2,2
#??#???#?????#? 4,3,3
#?????#.#?.? 2,2,1
#???.??.#.#? 3,1,1,1
???????#?.?#??## 2,2,5
???##?.#???????#. 2,3,4,3
?#??.???.#. 3,2,1
#?##?.?????.#?#?# 5,2,1,5
???#????#.?????? 4,1,1,2,1
#.?.?##?#?#???#? 1,11
?.??.?#??##?? 1,7
?????#..#?.##?#????? 1,2,1,4,3
#????.?##????##??# 1,1,4,5
?#????.???##? 3,5
?#?.??????? 3,1,1
.#.???#...#??. 1,3,3
?#?...???#? 2,1,1
??.#??.???..? 1,3,1,1
.?????.#?? 5,1
#?????#.##?#?????? 2,4,7,1
?.????.??#??#??#??.. 3,1,1,6
??????????? 2,7
?.????..?#?# 2,4
?????#..?#????# 1,1,1,3,2
??.#????###???????#? 9,4
?#??.##?.??.??????? 2,3,1,2,2
.#?##.?#??# 1,2,5
??###?#?#??????.?#? 1,8,2,1,2
?#.###???#??????? 2,11,1
?.?.????#??#?# 1,1,1,3
?????.??#???#? 3,2,2
?#..???.??##???#?? 2,2,3,1,1
??#?#..?#???? 3,1
?????????.? 2,1,1
??#?#?.?#?. 5,2
#????#?????#.??. 8,1,1,1
#???#?#???.##..?#. 8,2,1
.#.?#?##??.?..??.?#? 1,5,1,1,1,3
???#????.???.# 5,1,1,1
?#??..???#. 3,3
????#?????#..??#? 1,2,5,1,1
..???????##???? 3,5,1
??#?##.???#??? 5,3
??#?????????##?##?? 5,5,2
.#???????? 7,1
?.?.#.?#???????? 1,1,1,5,1
??##...??#?. 3,3
.??????#??? 2,1,1
#??.??????.? 3,1,1
..?..?..?????#? 1,3
??#.???????#??? 2,1,6,1
???#??.??. 3,1
.##???...#????##? 5,7
??###????.?????? 8,4
??##??..??.?# 6,1,2
?????#.??# 1,1,1
??#?????.?#??????? 4,1,1,4,2
??##??..??? 6,2
##?##??#?????#??#.# 11,1,2,1
.?##?#.?#. 5,1
?????#??????##? 1,11
????#????????####? 2,1,6
.?.?#???????? 6,1
???#?#????.??#?? 5,1
#??#.???##?????#? 1,1,6,1,3
.??.?#???????# 1,4,1,2
??????#???..??#?#?? 4,5
?????.?..????##?#. 2,8
?????.#.?#?? 4,1,3
?????#???.??.??# 1,1,2,1,3
?#??????.??#???#??? 1,1,2,4,4
.???#?#???. 1,1,3
????.??###??? 1,1,3,1
.?#????#?##?#.? 2,5,1
..?.????.?.??#??? 1,3
???##?????.. 3,1
##???????????#?? 8,2,1,1
????###?????##?..? 1,1,6,4,1
.?????????#??#??#?? 10,2,2
?#.??????? 1,1,1
#.????????## 1,1,1,2
??#?.??????#.?.???? 3,2,1,1,1,1
?#?.#??#??????.????? 2,7,1,4
?##??#????##?#?.##?? 2,3,3,2,4
#..#?.??#??#?? 1,1,6,1
#.???..???????? 1,1,1,4,3
?##????.?? 2,1,1
.?#??..##????..?? 2,6,2
..#?.##???. 2,4
#?.???#.?? 1,2,2
???##??????.??. 1,5,1,1
?#???#??#.????? 9,1
????#.???? 5,1,1
#??????.#???#???# 1,2,1,7,1
#?????##??#????.???? 3,8,1,1
?.#????##?#??.?..?? 1,2,8,1,2
#???????.??#? 1,2,4
??###??.?.? 6,1
.??????#.??? 1,1,1,3
.??#??###???#?..?#.. 9,1,1
?.?.??##?# 1,6
????#?????# 1,2,3
??##??????##??# 11,2
?#?????#?? 1,2,1
#.#??.???#.##????#? 1,2,2,1,8
?#.??#?????? 1,3,1,1
..???????.? 3,2
#??.?.???????? 3,1,1,1
??##???#???# 8,1
#????.?#??#????#.. 1,1,1,1,3,1
?####?#???.?.? 8,1
..#.???#??.. 1,4
.??.?#??????#???? 1,9,2
?#?.?????? 3,4
#??.#?????????? 2,2,3,3
??#????.???. 5,1,1,1
.??#???#.??#?. 3,1,3
.?#??#.#?.?#?.# 2,1,1,2,1
??????????.?????. 8,2
?.???.??.?? 1,1
#?.?????##..###? 1,1,4,4
?.#??.????.##? 2,3,2
????#????? 1,2,2
?###?.#???? 4,2
.?.?.????.?.#?? 1,1,1,1,3
.??#???.???#??##???. 4,5
..??#??#..##?#. 4,2,1
?##???##??.??????.?? 8,2,2
#??#?????#?#. 1,5,1,1
???.?????#??. 1,1,4
..???##??#??.?? 7,1
??.#.?????.??????#? 1,1,1,2,1,2
?#.#?.#????##??##? 2,1,1,1,2,2
?##?.?..##???? 3,1,4
????..?#??#.? 3,5
.#?##???.?#.. 6,1
?.?.???..#????? 1,1,1,2,1
?.#???#????#?#?### 1,12
??.?#?#..?#??.???? 3,3,1
???#?##?## 1,7
#???????.#.#..#? 6,1,1,1
????????.????#?? 2,2,1,1,3
?????.?#?#?#?????## 2,2,5,1,3
??????#.???? 1,4,1,1
?????#??.##?. 1,2,3
?????#???.???.? 1,6,1
?#??.??#????#??##? 3,11
??#?.#??#???? 2,4
..??#????.??? 2,1,1,1
??????#?#??..? 2,3,1
?#?#??.??###????? 4,5,1
???#??##?#??.?.??#? 1,1,6,1,1,1
##?.#.?.#??#.#? 3,1,1,2,1
?##??.?.?????#? 3,2,3
?##?#???##???#.#?#? 12,1,1,1
???#?#?.?#???. 4,3
.????##??. 2,2
??#???#??#?????????. 1,8,3,1,2
?#????#... 2,3
??.??#???? 1,3,1
?#?.????????#? 1,3,1,1
?..??#?.#.????? 4,1,1,2
?????.????#?????.?. 5,7,1,1
??.?#?.?##???#??#? 2,2,8,1
?????.#??#??#?????? 1,1,2,1,7
??.?????.#? 1,4,1
?#?#???..##?? 5,3
?.?.??????. 1,2,1
?#?#.?#?#???????.# 2,1,7,1,1
??????????????#???? 2,1,1,9
#?.???.??. 1,1,1
#?.?????#??.##?#? 1,1,4,5
?.????#??.? 3,1
???#??##????##??.?. 1,1,11,1
??#????????#? 1,4,1,1
???#...?.? 2,1
?#????##??#????. 1,1,2,5
?.?.#???????.#?.??. 4,2
.???.#?#?????#???#? 1,1,8,3
?.??.?.?.??# 1,1,1,3
#?..#?.?#? 2,1,1
?.????.#??#? 1,1,1,2
?#???????? 2,2,1
.?????.???.??????.. 3,1,1
.?#?.##?##. 1,5
??#????...?##. 6,2
??..#??#??????????. 1,14
#?.#?????##.#???.#.? 1,8,1,1,1,1
#????##???.????.?? 1,1,6,1,1,1
????#.???? 5,1
?##?#???####?#?? 4,1,7
?.?????.?#??.#? 1,4,2,1
??#?.?????. 2,1,1
???.?#???? 1,3
##?????#?#?.#??#?# 2,1,4,1,1,1
?#????.#??##.#?? 3,1,5,1
.?#.?#.#?.?? 2,1,2,2
??.????.#? 1,2,1
??..????#.?? 2,1,1
??.?.?#?#.???? 1,1,3,2
?#??.????#? 3,6
?????#????###?? 3,4
?##??.#????????#??? 4,1,4,1,2,1
??##?#??????????. 1,11,2
#?.??????#??#?#??##? 1,15
#?..???##?.#? 1,1,2,1
?.?????#??#???.? 1,6,1
?##??????#?.? 6,2
..?###??..?.????. 5,4
???#??..?.#. 3,1,1
??#??#???###.?#?? 12,2
?.?#..?#.? 1,2
##??#?????? 2,1,1
#?#?.#??#?.?# 4,4,1
???#??#.?? 1,2,1
?#?.??.???# 2,1,2
?#??#??#???.?.?#??? 10,2
?????.##?#???? 1,2,5,2
?.?.?#??????##. 1,3,4
.#??..????#..#.??? 1,2,2,1,1,1
.?..?#?..????? 3,1
??????????.??. 7,2
??.?#?###.??? 1,5,1
.???#??.??#??. 2,1,5
?#???????.??#? 2,2,4
#?#????.???#?? 5,2
?#??#???????#?.#?? 1,1,4,1,1,1
#?#??##..?#????#??. 7,1,3
?##???.#?. 2,2,1
.??.????#??#???? 1,7,1
?#?.??##?..??? 2,4,2
..?#??.??. 2,1
??????????????.???. 4,2
#.?#?#????#???#?.?? 1,1,11,1
??#??.#?..#?#. 1,2,1,3
.??????#?#?#??. 2,1,1,1,1
?.???.???##???? 2,1,4
??.??????.. 3,1
.?#?????#?#??..? 1,6
.?#?????????? 3,3
.??..#??.???? 1,3,2
??#?###??#??. 2,8
?.??##???#??#?.?? 1,5,6,1
????????#?? 2,1,4
??###?????? 4,2
?.###?????#???#. 3,2,1,3
#????#????? 1,4,2
????...??????#???.?? 1,2,1,1,6,1
??????#??#?.?.???# 1,1,7,1,3
??#.??#??? 2,5
.?##???#????##???#? 4,2,2,2
?#??#.??.???#?????#? 4,1,1,2,1,2
??.??????????.? 1,1,1,2,1
??.????#.????#? 1,1,6
??#??#?????? 7,2
???.??????#??????? 3,2,4
#?#?#?#?????.???? 1,1,8,1,1
???????#?????##????. 1,9
??.??.???##??.????.# 2,2,5,2,1
???#....#? 2,1
??##?.??????#.. 1,2,1,1,1
#?????##?#????#?. 5,5,1
???.#.????.???????? 2,1,1,1,3,1
#????.#????.????. 1,1,4,4
?????###???#??.#? 3,4,2,1
??.??#??????? 2,1,1
???..#???# 1,1,1
???????????????? 2,1,1,2,1
???##?????? 2,1
??????##????#???? 7,1,1,1
#?#?..???#?##? 4,5
#.????#?.????#.?? 1,2,1,5
.???.?????...?#?.?? 1,2
?#?.?#????????.???## 2,4,3,5
.??#.#????#?#????#?? 3,2,9,1
??####.???#?##?? 5,1,2,4
??????????#?#?#?? 1,1,1,2,3
?#?#?????###???##.. 4,2,8
???#??.?????#?? 1,2,1,4
?.???##???. 1,3,1
?#?#????#???#? 1,6,4
?.?#?.?????#??? 3,4
???##??#?## 1,2,4
?#?????????.?? 5,1
.??##????#?#?????? 2,6,1,1
?#??#??##. 1,5
?.????.??#?. 1,1,1,1
???#???.??#???#??#? 4,10
#???#?#.????????#? 7,1,1,1
#????#?#?? 4,3
???.??.?????? 1,2,3
??.#.??????##??? 1,1,1,1,6
??????.???? 4,1
?.?#??.#??. 3,1
?.##???#????#??????? 3,1,1,3,2
.?????#????.??#?.?. 3,1,3,1,1,1
?#??#??????#? 1,3,5
???#?.?.?. 5,1,1
##..??#??##?? 2,8
?????#????# 2,3
?#.???###?????.. 1,7
?###???#??##??# 8,5
??.?.?#????? 1,1,2,2
?#?.??.?#? 3,1
????????.????#?#.?# 1,2,1,6,1
??##...????.????#?. 3,1,5
????..???.?..? 3,1,1
.#???.###?#?? 2,3,2
?##?#??????.?...# 4,2,1,1,1
???#?????#.? 1,4
??.??#??..????. 1,3,1,4
.##?..??.?#?? 2,1,3
???##.?.?.?????#?? 1,2,1,3,2
??#??#?.?????????. 5,2,5
#??????#.??#?? 1,2,1,3
.??#???????? 7,2
.#?#?.??#.? 3,2
????##?##??..???. 9,2
.????.???#? 3,4
?.??#??###?#?#?. 9,2
???#???.?? 2,1
.?.??????? 1,2,2
??????????.#? 1,5,1
?????#?.???#??.??? 1,4
??#??.##.?? 3,2,1
???#???#??#?#????? 3,2,5,1,1
?#???????.. 4,2
.?????#????.?#?? 5,3
?..????##????????? 6,4
?????#?.?.??.#?? 3,3
???#???.#?#?.?#??? 1,2,1,1,2,3
#????.??#??. 4,1,3
???#??????#???##? 4,9
??.?..#?.????.. 2,1
#??#.??.#????#? 1,1,2,7
???.?#.?..?.?? 2,2,1,2
?.?#?##??.#.#?.?#. 1,5,1,1,1,2
?#?#??##???#???? 11,1
.????..#???##? 2,1,1,2
#??.??##?.?.??#??#? 3,4,1,3,3
##??.?#?.###? 2,2,3
?#???????????### 1,1,1,1,3
.?#?##???##??????? 4,4,1
?.????????#????? 2,2,6
?#??.?..######?# 2,1,8
???.??.???##..???#? 1,2,1,2,1,2
...##??.#?.?? 4,1,1
?.#?..??.? 2,2
?##??..?##???? 4,2,3
???#?#??????.?#??? 8,4
?#.?????##.??#? 1,2,4,2
???#.#???##?.# 3,2,2,1
?????????????..?.? 1,6
#???????.?# 4,2,1
???????#??? 2,1,3
.???.######?.? 1,6
??.??????. 2,1,1
?#????.????#?#.?.??# 3,7,3
??#??.????? 3,2
???#?????????????#?? 10,6
.?.????.???. 1,2,1,1
??.????#.?#?? 1,2,1,2
.?.???..?# 1,1,1
?#?...?##??? 2,2
##??##??#?.?.??. 10,1
??#??????????.?.??? 12,1,1
?????#?#???#????.?# 1,11,1
?.???.?.??? 2,3
??..?#?#??#???#?? 1,2,9
.#???..??## 3,1,2
?##?#??.?.????????. 6,1,1,1,1
??????#?????#??.?? 1,13,1
#?..????.#???#?? 2,1,6
.???#??..#? 4,2
????..?#?? 1,2
.??#????????.#.?? 8,1,1,1
#??.??.?#. 2,1,2
??#.?.??????##?? 1,1,4,3,1
??.??.?#?.?????#?? 2,1,1,2,3
?#????????#?.?#. 10,1
??.????????? 1,5,2
?????.?.???#???.?.?? 2,6
.?####?#?#???#??? 8,3,1
?????##.?#????.??.? 1,4,2,2,1,1
.?????????#??????#? 3,10
.??.????## 1,2,2
?.##.?.??##?.? 2,5
?????#???? 7,1
.?#...?.#. 1,1,1
.???##.???#.?.##?. 5,1,3
?.?????..?..# 1,2,1,1
??#??????#?? 4,4
?????#??.?. 4,1
???#?.?#?#??.? 2,1,5,1
??????.????. 1,1,1,2
.?.???#.#?????#?? 1,3,1,2,3
????#??????#??.??#? 12,1
??...?..??????#.?? 1,1,6,1
.?.??.???.?#?? 1,2,3
?.????#?????#?##??? 1,13
?.???#?##???.#..??? 1,1,1,4,1,1
?.#?##???#??#.?? 1,9,1,1
??#?.?#??#.? 1,5
??.#?????..????#???? 1,1,3,8
???#?#?#???#?.??# 1,10,2
.????##??? 1,5
???#??..?.? 6,1,1
?.?.????????#???? 1,1,3,1,5
????????#?..?????? 5,2,6
?????????#????#.?# 2,5,1,2
.???????#??#?? 2,6
#??..?##.?? 3,2
?????????#?#??#?#. 2,5,4
?#??.?.?#??? 4,1
###?????##.?.#?#... 10,3
???#?##?.???#?#????? 2,5,2,1,3
??#?.??.??#.##???#.. 4,1,1,1,4,1
??#???.??????.? 3,1,2,1,1
??#???#.??##????? 1,2,2,7
.?#??.????##??#?.?? 3,7
?.???.???? 1,1,3
?????.???????????### 1,1,1,1,1,5
?.?.?????#?..??#?#? 1,1,1,1,1,6
?.#.?.?????#?#?#?#?# 1,14
?..##???#??#??#????? 1,4,12
??????#?#?. 6,1
#??..??###??.??#???. 3,5,4
??##.?##.??????.? 3,2,1,1
??#????.??.????? 1,2,1,1,2
#?#????????.??????? 5,2,5
???????.????? 2,1,1,1
????.????###???? 2,6
#??##?##????.. 9,1
#??#.##??? 1,1,3
###?.?##?.? 3,4,1
??#???##?#?????# 2,11
.?#.??.??.? 1,2,1
??????#????.? 2,6
???##?#???.?#??#? 4,1,4
....???#?..##?..??? 5,2,2
?..?..?????.##?###?? 1,1,4,6,1
#??????????? 2,1,1,4
??#?????.?????#??.? 5,2,4
.?????.????? 1,1,3
?#?.?????#????#?#??? 3,2,1,5
.?#??????.? 3,1
#???.??.??.# 4,1,1,1
?.#?.????????.??? 1,2,2,1,2
??.?#?##??????.. 5,1
??####????.?#?.?? 7,2
.?###??????????## 5,2,1,2
#??.?????.???#? 2,2,1,2
????????#??.??#? 1,1,3,3
.?????????????# 3,7
###?#?.??? 3,2,1
?#?##??..#?#?? 5,1,1
.#?.?#...??# 2,2,3
.#???#?????#??. 1,1,6
??##????????? 5,4
.??##??.????.?? 5,1
???#?#.#??###?#?.# 1,1,1,1,5,1
?????#????? 3,1
.?????.?#.? 1,1,2
??????..?.?? 1,2,1,1
????#.???????????.? 1,7
??#??????##??#. 3,2,5
???????.???#??.???. 5,1,1,1,1,2
?#?????#?##.???#??.? 1,5,2,1,4,1
.???#..???????? 4,1,3
?????.???. 2,1,1
??#??.##??.? 2,2,1,1
.??#???????...??#??? 10,1,1,1
.##??#???????..????. 5,2,1
.?#?.?.???#? 2,3
???????.???#?? 1,2,5
???.??????.????#??? 3,3
??????????????#.? 1,1,1,5,1
???????.#?? 4,2
#?????#????????.? 1,1,8,1
###??#????? 6,1
???????????#?..???# 3,5,3
??#####??????.?? 6,3,1
?.????.??.?? 3,1
.##??#????#..??... 2,7,1
??#?#?????.#. 4,1,1
#?????##?#??..???? 2,1,6,1,2
??###????????? 7,1
???.??.#?#.?????? 3,2,3,2,2
?#?????#?????? 2,8
???????#?#? 1,2,3
?#?#??.?#.??##???? 4,1,1,1,5
??????#??# 1,5
?#?..??#??. 1,4
???????????. 4,1
.?##?#????????#??.. 4,8
???.????...????.. 2,2
??????.#..??? 1,2,1,1
?????????? 1,3
???#?.??????.? 4,1,1,1
?.???????#. 1,1,2
??.??????.????#?? 2,1,1,2,5
.???#??????.#??. 9,2
?#?#?.??.????. 2,2,2
.?.?????.? 1,2
#????#?#???.???.? 1,3,1,3
..#?##???????#??.??# 6,1,3,1,1,1
?.?..#?????.???????. 2,5
?.?.???.???? 1,2
?.#???.?..?.#?? 1,3,1,1,2
?.??#???.????? 1,4,1,2
#??.??.??# 3,2,1
????#???????#? 5,3
?#?.?#??.?????? 2,3,4
##???.??????? 5,1,1,1
??..?##?????????. 5,1
.??????.#??#.##...# 4,1,4,2,1
?.???#???.???. 1,4,2
##?#???????.?????##? 6,3,1,4
???.??.#?#? 2,1,3
???.?.##..?????? 2,1,2,4
#????#??##??.?#? 2,1,4,2
#????#?????.???.. 1,1,2,2,2
???#?.??.????? 1,3,5
?????##??????????# 1,6,1,1,1
?#?#???.#???????.. 4,8
???#??#???..?#?. 2,5,3
?.???#.?.??????? 2,2
.?#?#???#???#?#?? 4,9
.?#?..#?##????.???.. 2,4,1,1,1,1
???#..?.?? 4,1
.#??.?#???#??.???? 1,8,2
.?????#??##?#???? 2,2,2,1,1
???.?#?.?. 2,2
?##??#??.??.##??#??. 6,7
.#.??????#?????#?# 1,1,3,3,5
.?.?????????????##? 1,3,1,7
??.??????#?##??? 1,1,3,3,1
?????.##?#? 1,1,5
.##.??#?.??.?? 2,2,1,1
??#..#??#?..#??? 3,5,1,1
??#????????#?????? 13,2
?#????..?.??? 2,1,1
?????#?.#????. 4,2
.?##?.?..? 4,1
?##?#??#?##??#?? 12,2
#?##?.???????#?#?#? 1,2,1,8,2
?.?.##?.????#??# 1,2,1,1,4
????.???#?.? 1,1,2
..????##???????#???? 7,5
??????#??????? 1,8,2
?#?????????. 1,1,5
??#?##???????????.? 8,1,3
#.??##???###??. 1,10,1
.????#??#?#???.???# 12,4
??.?#????#?.???.. 1,7,1,1
???#####?????.##?? 7,1,3
?.?????.#?#?.?. 1,5,3,1
..??..##?????. 2,2,2
??????????#? 1,1,1,1
#?#??.??##??#..? 4,2,1
#?.????.???.? 1,4,3,1
?????#????##?#?### 1,1,1,1,8
?.??##??.?#.? 6,1
#???????.????? 4,1,3,1
#???#???#??..?#..??? 3,1,1,3,2,1
#??.???????#????? 3,9
??#?##????#??????.? 5,8
#???????#???.?#???#? 1,1,5,2,3
.#???#????###.??. 1,8,1
?#???#?##?##???##?#? 2,12,1
#.?.#???#.? 1,1,2
?.??#?#.???#?????.?? 3,3
???#.??.??#??#??? 1,5
?????#???? 2,3,1
????.?#??#?????????. 2,1,5,2,4
.?????.#???##?#.?.? 2,1,6,1,1,1
?..#?.??...?#? 1,1,1
?#.??????? 1,1,1
??###..?#? 4,2
????##.?#.#???????? 1,2,1,5,2
#??.?###?##???.?? 1,1,6,1,1
???#?????...???.??? 4,2
?.?.??.??#????.? 1,1,5,1
??#?.?????.?????? 2,1,1,1,4
?.?.???.?#?#???? 1,1,2,3,1
??##?..??#??.?.. 2,1,1
.??.??.???? 1,2,2
?#.??##????#.???? 1,3,3,2
??#?#??????#?# 5,7
??#.??#.#?#???. 2,1,1,6
??#????.??. 5,1
????#??.???##?#?#? 6,8
#???#??#?? 2,1,1
??.???#???#? 1,5
.#...??.????.?# 1,2,1,1,1
##.????#?.#..?#? 2,4,1,2
????#???#?.?.?#??? 9,1
?#.???#??#??????#? 1,4,1,1,1,1
??????.??.?????#..? 2,4
??.?###?.???#??##??? 4,5
?#..##???#?#?? 2,10
..??????#?.?##?. 1,4,3
?????????? 2,5
????.?????????#?##?. 1,1,2,2,2,5
.?????#?.#?????? 1,3,4,2
??.????#?. 1,4
?#?#..#.#??##????? 3,1,6,1
?..?.??.??????? 1,2,6
.#??#?#?????## 2,3,6
?#?..???...???##.? 1,3,5,1
?###??????##?#?..??? 3,3,6,2
?????#.?#???. 1,2,1,4
???????.??#???? 1,1,1,5
.???.??..?#???.?? 2,3
#.??.#?????..???# 1,1,3,1,4
?.??.?????????. 1,1,2,6
?#.#???..?.?#?? 2,1,1,1,2
????????#??.??#????? 1,1,4,1,6
.#????#?#.? 3,1,1
?#??#.????.#?.. 1,1,2,1,1
?????##??.?????? 2,6,1,2
#.??.???.???????. 1,2,1,1,4
??##?#?#??..??? 7,3
?#???.??.?. 4,2,1
?????#?????.# 5,1,1
?#?.??#?.?#? 1,3,3
?.??.???#?#???. 1,5
??##.?#???.???.#. 3,4,2,1
.???..??.??. 3,1,1
#?..?.??#?.? 2,3,1
##???#.?#?.#?? 6,1,2
?#.??.?#.? 2,1,1
???????????? 1,1,1,1
?..#???#??#?#?.?# 1,2,3,4,1
?##?#??????????##. 11,3
#?#??..?.#?????#???# 1,1,1,1,11
??.?##?#??.??#???? 1,6,5,1
??.?#?#..?.?. 4,1
##?..????.?#.?#? 3,1,2,2,2
???#.???#? 1,1,2
??#?????#?#?#???#? 13,1
??#?...??.#?.?#?? 1,2,1,2
?.??.????#.????.??. 1,1,1,1,4,1
??.?????.#? 1,5,1
??.#?????#.. 1,4,1
?..#??????.?? 2,1
??#???#?.#?? 6,2
???????#?.#?? 3,1,2,3
?#?#??##.?#???#??? 8,1,5
??##?????.????? 5,1,1,1
???..??.?##. 1,1,1,3
?.?#?..#.?#? 3,1,3
.???????#??#? 7,1
.#.????#?#?#?. 1,3,3,2
??#.#..????????#??#. 3,1,8,1
#??????#.??? 1,1,1,1
?#?????#???? 2,1,1,1
#?????#??#??#.?#??? 1,7,1,1,1
???#.???.???.?? 3,2,1,2
??#?.???#####?##?? 1,1,1,10
??#?????.#??? 6,1,2
????#????#?.?? 2,4,2
????????#? 1,1,5
???#???.?#.?? 4,2,1
?#??..???#?#??????#? 4,1,5,4
?#?.?#?#???##?#? 1,4,4,1
???#.?.#?????# 3,1,1,1
???.?#?.????? 2,1,5
.?????#?#??##.?????? 9,3
??#???#.???? 7,1
????#?####.?#? 6,2
?.?????????#??.# 1,1,2,6,1
?????.?.???#???? 4,1,4,2
#?.?.??#?#??? 1,1,3,1
??#?.?????#??? 4,1,5
?.?????.##..??? 1,2,1
???###?#??.???.? 7,1"

# Day One: Description ----------------------------------------------------
# You finally reach the hot springs! You can see steam rising from secluded 
# areas attached to the primary, ornate building.
# 
# As you turn to enter, the researcher stops you. "Wait - I thought you were 
# looking for the hot springs, weren't you?" You indicate that this definitely 
# looks like hot springs to you.
# 
# "Oh, sorry, common mistake! This is actually the onsen! The hot springs are 
# next door."
# 
# You look in the direction the researcher is pointing and suddenly notice the 
# massive metal helixes towering overhead. "This way!"
# 
# It only takes you a few more steps to reach the main gate of the massive 
# fenced-off area containing the springs. You go through the gate and into a 
# small administrative building.
# 
# "Hello! What brings you to the hot springs today? Sorry they're not very hot 
# right now; we're having a lava shortage at the moment." You ask about the 
# missing machine parts for Desert Island.
# 
# "Oh, all of Gear Island is currently offline! Nothing is being manufactured at 
# the moment, not until we get more lava to heat our forges. And our springs. 
# The springs aren't very springy unless they're hot!"
# 
# "Say, could you go up and see why the lava stopped flowing? The springs are 
# too cold for normal operation, but we should be able to find one springy 
# enough to launch you up there!"
# 
# There's just one problem - many of the springs have fallen into disrepair, so 
# they're not actually sure which springs would even be safe to use! Worse yet, 
# their condition records of which springs are damaged (your puzzle input) are 
# also damaged! You'll need to help them repair the damaged records.
# 
# In the giant field just outside, the springs are arranged into rows. For each 
# row, the condition records show every spring and whether it is operational (.) 
# or damaged (#). This is the part of the condition records that is itself 
# damaged; for some springs, it is simply unknown (?) whether the spring is 
# operational or damaged.
# 
# However, the engineer that produced the condition records also duplicated some 
# of this information in a different format! After the list of springs for a 
# given row, the size of each contiguous group of damaged springs is listed in 
# the order those groups appear in the row. This list always accounts for every 
# damaged spring, and each number is the entire size of its contiguous group 
# (that is, groups are always separated by at least one operational spring: #### 
# would always be 4, never 2,2).
# 
# So, condition records with no unknown spring conditions might look like this:
# 
# #.#.### 1,1,3
# .#...#....###. 1,1,3
# .#.###.#.###### 1,3,1,6
# ####.#...#... 4,1,1
# #....######..#####. 1,6,5
# .###.##....# 3,2,1
#
# However, the condition records are partially damaged; some of the springs' 
# conditions are actually unknown (?). For example:
#   
#   ???.### 1,1,3
# .??..??...?##. 1,1,3
#   ?#?#?#?#?#?#?#? 1,3,1,6
#   ????.#...#... 4,1,1
# ????.######..#####. 1,6,5
# ?###???????? 3,2,1
#
# Equipped with this information, it is your job to figure out how many 
# different arrangements of operational and broken springs fit the given 
# criteria in each row.
# 
# In the first line (???.### 1,1,3), there is exactly one way separate groups of 
# one, one, and three broken springs (in that order) can appear in that row: the 
# first three unknown springs must be broken, then operational, then broken 
# (#.#), making the whole row #.#.###.
#                    
# The second line is more interesting: .??..??...?##. 1,1,3 could be a total of 
# four different arrangements. The last ? must always be broken (to satisfy the 
# final contiguous group of three broken springs), and each ?? must hide exactly 
# one of the two broken springs. (Neither ?? could be both broken springs or 
# they would form a single contiguous group of two; if that were true, the 
# numbers afterward would have been 2,3 instead.) Since each ?? can either be 
# #. or .#, there are four possible arrangements of springs.
#                      
# The last line is actually consistent with ten different arrangements! Because 
# the first number is 3, the first and second ? must both be . (if either were 
# #, the first number would have to be 4 or higher). However, the remaining run 
# of unknown spring conditions have many different ways they could hold groups 
# of two and one broken springs:
#                                                                                                                                                                  
# ?###???????? 3,2,1
#   .###.##.#...
# .###.##..#..
# .###.##...#.
# .###.##....#
# .###..##.#..
# .###..##..#.
# .###..##...#
# .###...##.#.
# .###...##..#
# .###....##.#
# 
# In this example, the number of possible arrangements for each row is:
# 
#   ???.### 1,1,3 - 1 arrangement
# .??..??...?##. 1,1,3 - 4 arrangements
#   ?#?#?#?#?#?#?#? 1,3,1,6 - 1 arrangement
#   ????.#...#... 4,1,1 - 1 arrangement
# ????.######..#####. 1,6,5 - 4 arrangements
# ?###???????? 3,2,1 - 10 arrangements
#
# Adding all of the possible arrangement counts together produces a total of 
# 21 arrangements.
# 
# For each row, count all of the different arrangements of operational and 
# broken springs that meet the given criteria. What is the sum of those counts?


# Day One -----------------------------------------------------------------
#
# Phew, a brain burner! Managed to read the instructions wrong first not
# realising that the group lengths were in ORDER. I tried to solve for any 
# order, which messed up my thinking by complicating things. After reading a 
# hint on the subreddit i realised my misstake and started making progress 
# towards solving the problem. The function allowed_arrangements_old is my
# initial solution adjusted somewhat after looking at how other people had 
# solved it (my solution was slightly off in the conditions when encountering
# a #, otherwise it was correct).
#
# The function allowed_arangements is inspired by another solution that was 
# simplified in how it handled . and ?.
#
# I added caching to both functions to solve Part Two. Firstly I tried using 
# the memoise and parallel libraries. Neither worked well for this problem. 
# Instead i wound up using just the cachem library.
#
# mcmapply from parallel with 4 cores should cut the running time in four, but
# since each parallel execution wound up with it's own cache it took forever.
# Changeing to usining cachem cut the running time to a few seconds.
#
# Lessions learned, throwing more cores at a problem does not always solve it
# faster. Also, the same caching pattern I used 20 years ago still works today!
#

input <- data
records <- input |> 
  str_split_1("\n") |> 
  str_extract("(#|\\.|\\?)*")
group_lengths <- input |> 
  str_split_1("\n") |> 
  str_extract_all("\\d+") |> 
  lapply(\(x) as.numeric(x))

allowed_arrangements_old <- function(record, group_lengths, cache = TRUE) {
  sl <- str_length(record)
  if(sl == 0 & length(group_lengths) == 0) return(1)   # Nothing left of the record and all groups are handled!
  if(sl == 0 & length(group_lengths) > 0) return(0)    # Nothing left of the record, but there are still groups to handle? Something's awry!
  if(length(group_lengths) == 0 & str_detect(record, "#")) return(0)   # There are still # in the record, but no more groups. Something's awry!
  if(length(group_lengths) == 0 & !str_detect(record, "#")) return(1)  # There are no more groups to handle, and no more # in the record. All is well!

  # Caching! the use of is.key_missing is so that the key/value-pair won't be
  # removed between checking the key and getting the value.
  key <- paste0(hash(record), hash(group_lengths))
  if(cache) {
    value <- cm$get(key)
    if(!is.key_missing(value)) {
      return(cm$get(key))
    } 
  }
  
  r <- 0 # Result counter.
  head <- record |> substr(1, 1)
  
  if(head == ".") { # If the record starts with a ., discard it and move on...
    r <- r + allowed_arrangements(substr(record, 2, sl+1), group_lengths)
  }
  
  if(head == "?") { # If the record starts with a ? replace it with a . and a # and check again!
    r <- r + allowed_arrangements(paste0(".", substr(record, 2, sl+1)), group_lengths)
    r <- r + allowed_arrangements(paste0("#", substr(record, 2, sl+1)), group_lengths)
  }
  
  if(head == "#") { # If the record starts with a # it's time to check the first group left!
    gl <- group_lengths |> first()
    q1 <- gl <= sl                                     # The group length can't be longer than the number of characters remaining in the record!
    q2 <- !str_detect(record |> substr(1, gl), "\\.")  # The record can't contain any . between the start of the remaining record and the group length (that would break the pattern)
    q3 <- gl == sl                                     # This was the one I got wrong!
    q4 <- record |> substr(gl+1, gl+1) != "#"          # The record can't continue with a # after the group because of the rules (all groups are separated by at least one .)
    if(q1  & q2 & (q3 | q4 )) {                        # I moved the conditions to separate variables to make the conditionals easier to read
      r <- r + allowed_arrangements(substr(record, gl + 2, sl+2), group_lengths[-1]) # And we have a winner!
    } 
  }
  if(cache) {
    cm$set(key, r)
  }
  return(r)
}

# This function was inspired by someone else's solution. The conditionals for 
# checking the start of the remaining record is nicer than mine was so I stole
# them (with pride).
allowed_arrangements <- function(record, group_lengths) {
  sl <- str_length(record)
  if(sl == 0 & length(group_lengths) == 0) return(1)
  if(sl == 0 & length(group_lengths) > 0) return(0)
  if(length(group_lengths) == 0 & str_detect(record, "#")) return(0)
  if(length(group_lengths) == 0 & !str_detect(record, "#")) return(1)
  
  key <- paste0(hash(record), hash(group_lengths))
  value <- cm$get(key)
  if(!is.key_missing(value)) return(cm$get(key))

  r <- 0
  head <- record |> substr(1, 1)
  
  if(head %in% c(".", "?")) {
    r <- r + allowed_arrangements(substr(record, 2, sl+1), group_lengths)
  }
  
  if(head %in% c("#", "?")) {
    gl <- first(group_lengths)
    q1 <- gl <= sl
    q2 <- !str_detect(record |> substr(1, gl), "\\.")
    q3 <- gl == sl
    q4 <- record |> substr(gl+1, gl+1) != "#"
    if(q1  & q2 & (q3 | q4 )){
      r <- r + allowed_arrangements(record |> substr(gl + 2, sl+2), group_lengths[-1])
    } 
  }
  cm$set(key, r)
  return(r)
}

cm <- cachem::cache_mem(max_size = 1024 * 1024^2)

mapply(allowed_arrangements, records, group_lengths) |> sum()
# Answer: 8419

# Old solution:
mapply(allowed_arrangements_old, records, group_lengths, MoreArgs = list("cache" = FALSE)) |> sum()
# Answer: 8419

# Part Two: Description ----------------------------------------------------
# As you look out at the field of springs, you feel like there are way more s
# prings than the condition records list. When you examine the records, you 
# discover that they were actually folded up this whole time!
#   
# To unfold the records, on each row, replace the list of spring conditions 
# with five copies of itself (separated by ?) and replace the list of contiguous 
# groups of damaged springs with five copies of itself (separated by ,).
# 
# So, this row:
#   
#   .# 1
# Would become:
#   
#   .#?.#?.#?.#?.# 1,1,1,1,1
#
# The first line of the above example would become:
#   
#   ???.###????.###????.###????.###????.### 1,1,3,1,1,3,1,1,3,1,1,3,1,1,3
#
# In the above example, after unfolding, the number of possible arrangements for 
# some rows is now much larger:
#   
#   ???.### 1,1,3 - 1 arrangement
# .??..??...?##. 1,1,3 - 16384 arrangements
#   ?#?#?#?#?#?#?#? 1,3,1,6 - 1 arrangement
#   ????.#...#... 4,1,1 - 16 arrangements
# ????.######..#####. 1,6,5 - 2500 arrangements
# ?###???????? 3,2,1 - 506250 arrangements
#
# After unfolding, adding all of the possible arrangement counts together 
# produces 525152.
# 
# Unfold your condition records; what is the new sum of possible arrangement 
# counts?
#

# Part Two -----------------------------------------------------------------
#
# The hard part of Part Two was Partaking in finding out how memoise, cachem and
# parallel works (and doesn't work together).
#

records2 <- records |> 
  lapply(\(x) paste0(rep(x, 5), collapse = "?")) 

group_lengths2 <- group_lengths |> 
  lapply(\(x) rep(x, 5))
  
print(mapply(allowed_arrangements, records2, group_lengths2) |> sum(), digits = 16)

# Answer: 160500973317706


