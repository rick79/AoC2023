# Day 21: Step Counter

# Init --------------------------------------------------------------------
library(tidyverse)
library(collections)


# Data --------------------------------------------------------------------
test1 <- "...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
..........."

data <- "...................................................................................................................................
......#...........#................#......................................#.....#......#..##.#.......#....#.#........#...##...#....
...........#.................##...#...##......#............#...........##..#....................#.................#......#....#..#.
.....#.........#.....#.#.....###........###........#..........................##..##.......#.......#.....#...............#.......#.
....#..#......#......................#......#...............................#...........#........................#.............#...
.......#.....................#.............#......#...............#....................#............#.#.........#..#...............
.#.#.....#....#...................##......#..#..................#............................................#...............#.....
.....#....#...#....##...#......#.............#......##........#................#................#................#...............#.
.......#...................#..........#......................................#.........................##.........#..#.#..#........
....#..........#.........#....#......##...........##.................#................#...#............#...#..##....#...........#..
...#..........###............#.............#........................##..................#...##..................##......#...#......
.......#.......#.#..#.......#.......##..........#.........#..............................##.....#..#..........#.....#......#.......
..#.........#.....#..#..#..#..................#.........................#......................#.#..#...#..........#.....#....##.#.
..................................#.....#................#........#..........................#........#.....#...............#....#.
..........#..........#.#.................#.#.........................................#.......#..........#..##...#......#...........
.........#........#...........#...#.#....#.................##..#....................#..........#....#.#....##........#.......#.....
....#........#....................##..#......................#......#.........................#..#............................#....
...#.#...#...#......................#..#..........................#...#.#...............#......#.#........#....#..........#.....#..
..............#.....#.#......#........#...#..........#..#.#..#.........................#.....#..#......#.......#......#.......#....
.......................#.....#.....#................................##...#..#...#...........#..#..........#..#.#...#.........#...#.
.........#........#......#..#................................#.##.........#...#.................##......#.........#.##...#...#.....
.#.#.........##....#..........#..##.....................#..##...#..#..#...#.......#...........................#....................
.#.#......#..#..............##.#...#.#.............#.........#..............#.....#...............#..........................#...#.
.....##.....#.....##..#...#..#..#......................................#......#.............#.............#.....#......#........#..
......................#........#................#.......#..........#.............##............#..........#....#............#......
.....#..............................#.......##......#..#....#..............#.....................................#.....#.........#.
....................##...........#................#.#.....#.............#......#..##...#....................#................#.#...
.................................#...........#.....#..#..#..............#..##.........#..............#......#................#.....
............##.................................#..#...##.#........#...................................#...........#.#........#...#.
...#.......#.#........#......#...........#....#..#.......#....#........#.#.#.............##.......#.................#..............
...###............#......................##..##.........................#.........#......#..............#..#............#..........
..#.......#...##...#..#.......#.......#...#...........................................#...................#........##....#..#......
..#..................#.....#...........#.................#.#.#...........#..................#............#.......#.................
...##..#.............#.....#.....................#................#..........................#.............##...............#......
............#....#....#...#............#....#...........#.#.................#....#..................................#..............
...#.....#.............#...........................#.....##..........#...............#....#...............#........................
......#.....##.........#..........##..#...............#....#..#.#.#.....#.............#.###..............#..#......................
....................#...#...............#....................#...............#.#.#..##.............................#...............
...................#...#...........#...#.#...#...........#..............#............#..#......#............#.............#......#.
...#................#.................#.....#..........#........#.#........#...................#..#...........#.##........#......#.
....................#..........#....................#....#...#.....................#.......#.................#......#........#.....
...#.........#...................#.......##...###......#..#.......#.#..................#............#...........#....#...........#.
......#..#.#...#.#...............#.......................#.........#.......##................#...................#.###.............
...............#..............................................#.....#....#...#..#...#.....#......#.....#...........................
.......#.......#..........#.#.#..#.....#...#......#.................#........#...#..#.#.......#....................................
...........#..#.....................#.........................#...#.#.....#..........#....##.....#.................................
.......#.#.#.#..........#...#.##.##..#....................#.#.#..............#...................#....##...........................
.........................#.#.#...................#......#......#.............#.....#..............#......###..............#.#......
......#...............#...........#...................##..............#.##..#.#.#.#.#......#.....#.##.......#............#.#....##.
.....#....#.............#..##........###...#.......#.....#....#.......###....................#..#.#............................#...
.#........................#.....#......#.#.....................#......#.#...........#..#.....#.#.#..........#..............#...#...
.....##...#.........#.#.#.#...................#..#..#.#..#...#..#.....#.#.....#.........##.........................................
.................#.#...............#...............#...........#...........#.....#..........#...#.............................#....
.......................##...........#..........#...............#..#......................................#...#................#..#.
......#......................#..##.#........#.............#.....#..#....................#......#.........#.....#...#...........#.#.
.....................#.................#....##..#....#....##..#..............#..............#.....#...............#................
.#.................##.....#.#....#.....................#.............#....#......#...................#.#.##....................#...
.##..........##....#.##......#..#.................#...#..##........#....#..#.......#..............#.......#........................
......................#...........###.#.....##.............##........#..................#..............................#........#..
..#........................#...................#.#.#...#........#........#....#.....#.....#........................#...............
.#...........................#........#.....................#.....##.#..#.....#......#....#...#............##......................
............#...#..#..........#..............#...#...#..#..........#.........#...............#....#.#......#.#...#.................
..............................#..##...............#.....#....#.........................#....#...#....#.....#....#..................
..................#.#.........................#.......#........#.......#..##....#...#....#..................................#......
..........................#..#...#....................................#......#...#...#..#...#....#.............#.#.................
.................................................................S.................................................................
..............#...#...#.....##....#..................#....#........##..#.....#.#...#.#..............#.................##...........
.........##.........#............##.............................#.#...#.#.......#..........####....#...........#...........#.......
.........#...............................#...............#........................#......#..#......#.............##................
.............#..............................#...#.................#..........###.#.#.#.........#........#..........................
.#........#..#...........##...........#.#..........................#.........#....#.............#.............##...................
..#..........#..........................#...#..#..#.##...#..............#.....#...#............##........#.#.......#............#..
.................#.........#.......#.......#............#.#.................##...#.##.....................#.....#..................
.#.##..........#...#...................#...#.....##.....#...............#..#.........#..............#.................#............
.....#.......#..##....#..........#........#.#.....#.........#...............##......#.#....#.....#.................#...............
......#.......#.#...#....................#...............#.........#....#..#.#..........##.....#...#........................#......
.#.................#.................#.#....................#..............#.................#......#.......#.....#................
.#..#................................#......#..........#..............#.#.##.......................#...............................
..#.#............#.#......#...............#.#....#...#.#..#.......#...#.....#.......#........#.#...........#...#............##.....
.......#..........#....#....................#................##...........#......#..#...#....#...#......................#...#.#....
.........##........#........#......#.......#........#..#................#..#.............#..................#.#..........#.........
......#....#.................................#..#.#....#..............#........#.....#.##........#..........#.............#....#...
.............#........#.........#...##.....#.....#................##..........#.......#....#.......................................
..........................#.....#..#......#....#....#..##...#.......................#..............#.......#..........#..#......#..
...#.......................#....#.......#......#..................#................#...##........##.#............................#.
....#....................#.####..........#......#.....#......#....#.#.#................#...#..............#.............#.....#....
..........#..#...#..............##..#..#..#..........#.......#.##........##..............#.....#......#............#...#...........
..........................#..#..............#..#....#..#..............#.#...#..........#.....#..#.#................................
.......#.......#...............#.........#..#.#...#.....................#.....#......................#..............#.#..#.........
........#.....#.............#....................#.#........#.................#.....#...#..........#............#...............#..
.............#....##.........#.#................#....#.........#...#.......................#.....#.#..................#......#.....
...............#.....#.............#.....#.......#.......#......#.#..#.....#...#...#.......#................#...#................#.
...................#..#...........#..###....................#......#........#......#...........................#......#.......#....
..#.....#.##......#................#.................#.................##....................#.#...........#....#.#...#........#...
....#......#.#..#........#..............#.......#.........#.................#.............#.#...#...........#.#................#...
..#....#.#.......#...#.................#......#....#................#.......................#...#.........##..........#.........#..
..............#...............................#.##..............................#.......#..#...#...................#...#........#..
.#..#....#......#.....#...#............#..............................#..............#....................#..##..............#..##.
.......##............#..#............######............#................#..........#.#...#...#................#....................
...#..................##....................#.......#.#....##...................##..#....#..#..........#.....#.....................
...#.....#..#..#.#.......................#......................#...........#......###...#.............#........................#..
.....#.............#..........#......................#....#............#.##....#.......#.............#..........#........##........
........#...#.#..................#........#.#......#........#.....##...#...#....#...#......................................#.......
...............#............#..#.......................##.#.....#...#.#........#..................#......#.........................
.............##..#.......#.#.....#............#............#..........##.......#.....##...............................#...#........
.#..##...............#..............#...........#..#..#...##.......#..#.......................#.......##.....................#.#...
.....................###........#..#.....................#........#...#.##...................#....##.........#.........#...........
...#.....#...............#....#..###.......................................#..................#....................................
...#.#.#.....#..#.........#.....#...##.............#................#......#.....#........................#....#..............#....
...........#......#..##.......#......#..................#.....##..................#........#.......#......#...#...#..#...#.........
.........#.#.........#......#............................#.....#............#.................#..........#..............#.......#..
............#.........#.#....#.......#...................................#..............##.##..............#....#...............#..
.............#.....##.........#.........##...............#...............#.............................###........#.....#.#........
......##..........#....#.#.#..........##.#.#................#...#....##.......................#.......#...#.#........#.#..#........
....#....#............#.#......#..#.........#.............#.#..........................#.......#..............#..#..#.....#........
...................#...........#....#...#..#..#.......#..#...#.#........................#.................#.............#..........
.........#..#...#......#......#......#.................#...........#...................#........#.......#......#.#.......#.......#.
..#..#......#.....................#...........................#.....##................#.............................#..............
..#.#.......#........................#.......#..........................#................#.....#...#.........#.#......#............
...............................#....................................#.......................##....#......#.#.........#.#.........#.
.#.....................#......#..........#......#..............#...............##............#...#.##...#......##...#.#.#..........
...............#.#......#..................#......................................................#........................#.#.....
...#...#..#...............##...#...#.....#...#....................#..#..........#.....##......................................#....
.#..#...#........................#....#...##......#...........#.......................#...##......#.......#................#.......
....#...........#.............#.....#..#..#.....#.................................#........#.#..............#......................
....#....#........#..#.#..............#................................................#..............#................#.........#.
.....#..........#.......#..................#................................................#..............##...#..................
................#...............#..........#............##.........................#........#.#...............#...##...............
........#..................#..#.....#.#.........#.....#.#.#..................#.......#.#......#....#.........#..#.........#...#....
..#...........##...............#...........#..#...#...#.#..................##......#.....#.......#........#..#...#......#........#.
..................................................................................................................................."

# Part One: Description ---------------------------------------------------
# You manage to catch the airship right as it's dropping someone else off on 
# their all-expenses-paid trip to Desert Island! It even helpfully drops you off 
# near the gardener and his massive farm.
# 
# "You got the sand flowing again! Great work! Now we just need to wait until we 
# have enough sand to filter the water for Snow Island and we'll have snow again 
# in no time."
# 
# While you wait, one of the Elves that works with the gardener heard how good 
# you are at solving problems and would like your help. He needs to get his 
# steps in for the day, and so he'd like to know which garden plots he can reach 
# with exactly his remaining 64 steps.
# 
# He gives you an up-to-date map (your puzzle input) of his starting position 
# (S), garden plots (.), and rocks (#). For example:
# 
# ...........
# .....###.#.
# .###.##..#.
# ..#.#...#..
# ....#.#....
# .##..S####.
# .##..#...#.
# .......##..
# .##.#.####.
# .##..##.##.
# ...........
#
# The Elf starts at the starting position (S) which also counts as a garden 
# plot. Then, he can take one step north, south, east, or west, but only onto 
# tiles that are garden plots. This would allow him to reach any of the tiles 
# marked O:
# 
# ...........
# .....###.#.
# .###.##..#.
# ..#.#...#..
# ....#O#....
# .##.OS####.
# .##..#...#.
# .......##..
# .##.#.####.
# .##..##.##.
# ...........
#
# Then, he takes a second step. Since at this point he could be at either tile 
# marked O, his second step would allow him to reach any garden plot that is one 
# step north, south, east, or west of any tile that he could have reached after 
# the first step:
# 
# ...........
# .....###.#.
# .###.##..#.
# ..#.#O..#..
# ....#.#....
# .##O.O####.
# .##.O#...#.
# .......##..
# .##.#.####.
# .##..##.##.
# ...........
#
# After two steps, he could be at any of the tiles marked O above, including the 
# starting position (either by going north-then-south or by going 
# west-then-east).
# 
# A single third step leads to even more possibilities:
# 
# ...........
# .....###.#.
# .###.##..#.
# ..#.#.O.#..
# ...O#O#....
# .##.OS####.
# .##O.#...#.
# ....O..##..
# .##.#.####.
# .##..##.##.
# ...........
#
# He will continue like this until his steps for the day have been exhausted. 
# After a total of 6 steps, he could reach any of the garden plots marked O:
# 
# ...........
# .....###.#.
# .###.##.O#.
# .O#O#O.O#..
# O.O.#.#.O..
# .##O.O####.
# .##.O#O..#.
# .O.O.O.##..
# .##.#.####.
# .##O.##.##.
# ...........
#
# In this example, if the Elf's goal was to get exactly 6 more steps today, he 
# could use them to reach any of 16 garden plots.
# 
# However, the Elf actually needs to get 64 steps today, and the map he's handed 
# you is much larger than the example map.
# 
# Starting from the garden plot marked S on your map, how many garden plots 
# could the Elf reach in exactly 64 steps?

# Part One ----------------------------------------------------------------
#
# Pretty straightforward problem, once I understood what was asked for. That
# took a bit longer than what it should have taken.
#

garden <- data |> 
  str_split_1("\n") |> 
  str_split("") |> 
  {\(x) unlist(x) |> matrix(ncol = length(x), byrow = TRUE)}()

system.time({
  goal_positions <- list()
  step_goal <- 64
  step_mod <- step_goal %% 2
  seen <- dict()
  que <- queue()
  que$push(list(pos = c(which(garden == "S", arr.ind = TRUE)), steps = 0))
  while(que$size()> 0) {
    c <- que$pop()
    if(c$steps > 0 & c$steps %% 2 == step_mod) 
      goal_positions <- append(goal_positions, list(c$pos))
    if(c$steps == step_goal) next
    for(d in list(c(1, 0), c(-1, 0), c(0, 1), c(0, -1))) {
      n_pos <- c$pos + d
      if(n_pos[1] >= 1 & n_pos[1] <= nrow(garden) & n_pos[2] >= 1 & n_pos[2] <= ncol(garden) & !seen$has(n_pos))
        if(garden[n_pos[1] %% nrow(garden), n_pos[2] %% ncol(garden)] != "#") {
          que$push(list(pos = n_pos, steps = c$steps + 1))
          seen$set(n_pos, 1)
        }
    }
  }
  goal_positions |> unique() |> length() |> print()
})
# Answer: 3770

# Part Two: Description ---------------------------------------------------
# The Elf seems confused by your answer until he realizes his mistake: he was 
# reading from a list of his favorite numbers that are both perfect squares and 
# perfect cubes, not his step counter.
# 
# The actual number of steps he needs to get today is exactly 26501365.
# 
# He also points out that the garden plots and rocks are set up so that the map 
# repeats infinitely in every direction.
# 
# So, if you were to look one additional map-width or map-height out from the 
# edge of the example map above, you would find that it keeps repeating:
#   
#   .................................
# .....###.#......###.#......###.#.
# .###.##..#..###.##..#..###.##..#.
# ..#.#...#....#.#...#....#.#...#..
# ....#.#........#.#........#.#....
# .##...####..##...####..##...####.
# .##..#...#..##..#...#..##..#...#.
# .......##.........##.........##..
# .##.#.####..##.#.####..##.#.####.
# .##..##.##..##..##.##..##..##.##.
# .................................
# .................................
# .....###.#......###.#......###.#.
# .###.##..#..###.##..#..###.##..#.
# ..#.#...#....#.#...#....#.#...#..
# ....#.#........#.#........#.#....
# .##...####..##..S####..##...####.
# .##..#...#..##..#...#..##..#...#.
# .......##.........##.........##..
# .##.#.####..##.#.####..##.#.####.
# .##..##.##..##..##.##..##..##.##.
# .................................
# .................................
# .....###.#......###.#......###.#.
# .###.##..#..###.##..#..###.##..#.
# ..#.#...#....#.#...#....#.#...#..
# ....#.#........#.#........#.#....
# .##...####..##...####..##...####.
# .##..#...#..##..#...#..##..#...#.
# .......##.........##.........##..
# .##.#.####..##.#.####..##.#.####.
# .##..##.##..##..##.##..##..##.##.
# .................................
#
# This is just a tiny three-map-by-three-map slice of the inexplicably-infinite 
# farm layout; garden plots and rocks repeat as far as you can see. The Elf 
# still starts on the one middle tile marked S, though - every other repeated S 
# is replaced with a normal garden plot (.).
# 
# Here are the number of reachable garden plots in this new infinite version of 
# the example map for different numbers of steps:
#   
# In exactly 6 steps, he can still reach 16 garden plots.
# In exactly 10 steps, he can reach any of 50 garden plots.
# In exactly 50 steps, he can reach 1594 garden plots.
# In exactly 100 steps, he can reach 6536 garden plots.
# In exactly 500 steps, he can reach 167004 garden plots.
# In exactly 1000 steps, he can reach 668697 garden plots.
# In exactly 5000 steps, he can reach 16733044 garden plots.
# However, the step count the Elf needs is much larger! Starting from the garden 
# plot marked S on your infinite map, how many garden plots could the Elf reach 
# in exactly 26501365 steps?

# Part Two ----------------------------------------------------------------
#
# Step 1, deduce that the problems of the last few days have been more difficult
# versions of earlier days. So todays problem should have something to do with
# quadratic formulas.
#
# Step 2, fix the calculation of the number of reachable garden plots so it can
# handle an infinite grid. This is easily done by adding a modulus when 
# checking if a plot is within the grid and not a #.
#
# Step 3, look at the subreddit for clues. Because this one really hurt my 
# brain. An lo and behold, the mention of quadratic formulas and quadratic fit.
#
# Step 4, look at other solutions and get a headache. Combinatorial problems
# has never been my strong side, and the geometric inspired solutions that I
# found made no sense to me. So quadratic formulas it is!
#
# I must admit that I had to look up what a quadratic fit was since the term
# was new to me. Happily enough it was quadratic regression so no problems 
# there. But regression usually gives you all kinds of funky non integer 
# numbers, but again having learned from previous days I assumed that the input
# data was created in such a manner that it would be solvable.
#
# The biggest issue I had was that had experimented with my code and had removed
# the step_mod value from my function, so it computed the wrong number of 
# reachable garden plots for odd number of steps (64 and 65 steps gave the same
# number of reachable garden plots of 3770). So the first tries to solve the
# problem failed miserably, and I couldn't understand why it didn't work. To 
# validate my answers I used Wolfram Alpha, but since my function calculated the
# wrong number of reachable plots Wolfram gave me the wrong answers as well.
#
# With that out of the way it was easy to get the coefficients for the 
# the second degree polynomial by using R's functions for linear models and 
# polynomials. Fun fact, the polynomial functions result was quite similar to 
# the Vandermonde matrix used by others to calculate the answer. Almost as if 
# there is some connection here ;)
#
# With the regression model properly fitted to the data calculating the answer
# was as easy as to add up the coefficients multiplied with 202300, a number
# I derived from taking the number of steps, 26501365, subtracting 65 for the 
# steps taken in the first tile and dividing with the tile size of 131. This
# is the number of tiles from the center tile out to the outermost tile along 
# the horisontal or vertical axis. Since the data has been constructed in such a
# way so that the horisontal and vertical lines going through the garden grids
# center is devoid of blocking #, and the fastest path thus is along these
# lines.
#
# A weird artifact from the lm function was that somehow R rounded the result
# upwards one step, so the answer differed by 1 from Wolfram. Casting the 
# coefficients as integers solved this. None of the coefficients looked like
# anything other than integers upon visual inspection but something was off.
#
# Next time I encounter a problem I don't know how to solve from the description
# I'll follow one of my old math teachers advice. When in doubt, derive. If 
# still in doubt, derive again. If you can't derive, plot. Doing so would've
# saved me a few hours of headache since I'd seen the quadratic nature of the
# number of reachable garden plots for each garden tile.
#

reach <- function(start, step_goal) {
  goal_positions <- list()
  seen <- dict()
  que <- queue()
  step_mod <- step_goal %% 2
  step_count <- 1
  que$push(list(pos = c(which(garden == "S", arr.ind = TRUE)), steps = 0))
  while(que$size()> 0) {
    c <- que$pop()
    if(c$steps > 0 & c$steps %% 2 == step_mod) 
      goal_positions <- append(goal_positions, list(c$pos))
    if(c$steps >= step_count) step_count <- c$steps
    if(c$steps == step_goal) next
    for(d in list(c(1, 0), c(-1, 0), c(0, 1), c(0, -1))) {
      n_pos <- c$pos + d
      if(!seen$has(n_pos)) {
        if(garden[(n_pos[1] - 1) %% nrow(garden) + 1, (n_pos[2] - 1 ) %% ncol(garden) + 1] != "#") {
          que$push(list(pos = n_pos, steps = c$steps + 1))
          seen$set(n_pos, 1)
        }
      }
    }
  }
  return(goal_positions |> unique() |> length())
}

# reach(c(66, 66), 64)
# reach(c(66, 66), 65)
# reach(c(66, 66), 196)
# reach(c(66, 66), 327)

options(scipen=999)

x <- (26501365 - 65) / 131
data <- tribble(~x, ~s, 0, reach(c(66, 66), 65), 1, reach(c(66, 66), 196), 2, reach(c(66, 66), 327))
p <- lm(data$s ~ poly(data$x, 2, raw = TRUE))
c <- p$coefficients |> as.integer()
c[1] + c[2]*x + c[3]*(x**2)

# Answer: 628206329871085

data |> 
  ggplot(aes(x = x, y = s)) +
  geom_point(shape = 18, size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "#fa33ff")

